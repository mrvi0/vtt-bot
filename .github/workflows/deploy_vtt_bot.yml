name: Deploy VTT Bot Source to VPS2 (Git Pull)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy-source:
    name: Deploy Source via Git Pull on VPS2
    runs-on: [self-hosted, linux, l1-ci] # Ð Ð°Ð½Ð½ÐµÑ€ Ð½Ð° L1 (Ð¸Ð»Ð¸ GitHub-hosted, ÐµÑÐ»Ð¸ L1 Ð½Ðµ Ð½ÑƒÐ¶ÐµÐ½)
                                        # L1 Ð·Ð´ÐµÑÑŒ Ð½ÑƒÐ¶ÐµÐ½ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ Ñ‚Ñ€Ð¸Ð³Ð³ÐµÑ€Ð° SSH ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð½Ð° VPS2

    steps:
      # Ð¨Ð°Ð³ Checkout Ð·Ð´ÐµÑÑŒ Ð½Ðµ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÐµÐ½, Ñ‚Ð°Ðº ÐºÐ°Ðº Ð²ÐµÑÑŒ ÐºÐ¾Ð´ Ð±ÑƒÐ´ÐµÑ‚ Ð½Ð° VPS2
      # ÐÐ¾ Ð¾Ð½ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð¿Ð¾Ð»ÐµÐ·ÐµÐ½ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¾ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ðµ Ð´Ð»Ñ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹
      - name: Checkout Code (for metadata)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð²ÑÑŽ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾Ð³Ð¾ git rev-parse

      - name: Deploy to VPS2 via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS2_WG_IP }}
          username: ${{ secrets.VPS2_SSH_USER }}
          key: ${{ secrets.L1_TO_VPS2_SSH_KEY }} # Ð˜Ð»Ð¸ ÐºÐ»ÑŽÑ‡ Ð¾Ñ‚ GitHub-hosted runner'Ð°, ÐµÑÐ»Ð¸ Ð½Ðµ L1
          # port: 22
          script: |
            set -e # Ð’Ñ‹Ñ…Ð¾Ð´ Ð¿Ñ€Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐµ
            APP_DIR="/root/vtt-bot"
            VENV_DIR="$APP_DIR/.venv"
            SERVICE_NAME="vtt-bot.service" # Ð˜Ð¼Ñ Ñ‚Ð²Ð¾ÐµÐ³Ð¾ systemd ÑÐµÑ€Ð²Ð¸ÑÐ°

            echo ">>> Navigating to project directory on VPS2: $APP_DIR"
            cd $APP_DIR

            echo ">>> Creating/Updating .env file on VPS2..."
            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ .env Ñ„Ð°Ð¹Ð» Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ Ð¸Ð· ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð² GitHub
            echo "DB_NAME=data/vtt_stats.db" >> .env
            mkdir -p data # Ð”Ð»Ñ Ñ„Ð°Ð¹Ð»Ð° Ð‘Ð”

            echo ">>> Fetching latest changes from Git repository..."
            # Ð£Ð±ÐµÐ´Ð¸ÑÑŒ, Ñ‡Ñ‚Ð¾ Ð²ÐµÑ‚ÐºÐ° 'main' (Ð¸Ð»Ð¸ Ñ‚Ð²Ð¾Ñ Ð¾ÑÐ½Ð¾Ð²Ð½Ð°Ñ) Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð° Ð½Ð° VPS2
            git fetch origin main
            git reset --hard origin/main # ÐŸÑ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð´Ð¾ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ ÑƒÐ´Ð°Ð»ÐµÐ½Ð½Ð¾Ð¹ Ð²ÐµÑ‚ÐºÐ¸
            # Ð˜Ð»Ð¸, ÐµÑÐ»Ð¸ Ñ…Ð¾Ñ‡ÐµÑˆÑŒ ÑÐ¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ (Ð½Ðµ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ Ð´Ð»Ñ CI):
            # git pull origin main

            echo ">>> Activating Python virtual environment..."
            if [ -f "$VENV_DIR/bin/activate" ]; then
              source $VENV_DIR/bin/activate
            else
              echo "ERROR: Virtual environment not found at $VENV_DIR. Please set it up."
              exit 1
            fi

            echo ">>> Installing/Updating Python dependencies..."
            pip install -r requirements.txt

            echo ">>> Restarting $SERVICE_NAME ..."
            # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ sudo, ÐµÑÐ»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ VPS2_SSH_USER Ð½Ðµ root Ð¸ Ð½Ðµ Ð¸Ð¼ÐµÐµÑ‚ Ð¿Ñ€Ð°Ð² Ð½Ð° systemctl Ð±ÐµÐ· sudo
            # ÐœÐ¾Ð¶Ð½Ð¾ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ÑŒ sudoers, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ñ€Ð°Ð·Ñ€ÐµÑˆÐ¸Ñ‚ÑŒ ÑÑ‚Ð¾Ð¼Ñƒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ ÑÐµÑ€Ð²Ð¸Ñ Ð±ÐµÐ· Ð¿Ð°Ñ€Ð¾Ð»Ñ
            sudo systemctl restart $SERVICE_NAME

            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ° Ð¿Ð¾ÑÐ»Ðµ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ° (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)
            sleep 5 # Ð”Ð°ÐµÐ¼ ÑÐµÑ€Ð²Ð¸ÑÑƒ Ð²Ñ€ÐµÐ¼Ñ Ð½Ð° Ð·Ð°Ð¿ÑƒÑÐº
            sudo systemctl is-active --quiet $SERVICE_NAME && echo ">>> $SERVICE_NAME is active." || (echo ">>> ERROR: $SERVICE_NAME failed to start." && exit 1)

            echo ">>> VTT Bot Source Code Deployment complete on VPS2."

      - name: Send Telegram Success Notification
        if: success()
        uses: appleboy/telegram-action@v0.1.1
        with:
          to: ${{ secrets.TG_ALERT_CHAT_ID }}
          token: ${{ secrets.TG_BOT_MONITOR_TOKEN }}
          message: |
            ðŸš€ VTT Bot (Source) Deployed to VPS2
            Repo: ${{ github.repository }}
            Branch: `${{ github.ref_name }}`
            Commit: `${{ github.sha }}`
            By: `${{ github.actor }}`
            Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Send Telegram Failure Notification
        if: failure()
        uses: appleboy/telegram-action@v0.1.1
        with:
          to: ${{ secrets.TG_ALERT_CHAT_ID }}
          token: ${{ secrets.TG_BOT_MONITOR_TOKEN }}
          message: |
            ðŸ”¥ VTT Bot (Source) Deployment Failed!
            Repo: ${{ github.repository }}
            Branch: `${{ github.ref_name }}`
            Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}